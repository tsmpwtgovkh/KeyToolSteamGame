<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Steam KeyMaker ‚Äî Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Generate secure license keys in the browser (HMAC-SHA256, base64url)">
  <link rel="icon" type="image/png" href="skm-logo.png">
  <style>
    :root{
      --bg: #0b0f1a; --panel: rgba(17, 24, 39, .72); --text: #e5e7eb; --muted:#9ca3af;
      --border:#2b3753; --accent:#7c4dff; --accent-2:#00d4ff; --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 0 80px rgba(124,77,255,.15); --radius: 16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1000px 600px at 20% -10%, rgba(124,77,255,.22), transparent 40%),
        radial-gradient(1000px 600px at 120% 10%, rgba(0,212,255,.18), transparent 35%),
        linear-gradient(180deg,#0b0f1a 0%, #0a1224 100%);
      font:14px/1.45 system-ui, Segoe UI, Roboto, Arial, sans-serif; letter-spacing:.2px;
    }
    .wrap{max-width:980px;margin:0 auto;padding:28px 22px 40px}
    header{display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px;user-select:none}
    .logo{width:36px;height:36px;border-radius:12px;object-fit:cover;object-position:center;box-shadow:0 0 18px rgba(124,77,255,.25)}
    h1{margin:0;font-size:20px;font-weight:700}.sub{color:var(--muted);font-size:12px;margin-top:2px}
    .card{position:relative;background:var(--panel);border:1px solid transparent;border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);backdrop-filter:blur(10px);margin-bottom:16px}
    .card::before{content:"";position:absolute;inset:0;padding:1px;border-radius:inherit;background:linear-gradient(135deg, rgba(124,77,255,.6), rgba(0,212,255,.6));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none;opacity:.6}
    label{display:block;color:var(--muted);font-size:12px;margin:8px 0 6px}
    input,button{font:inherit;color:inherit}
    .input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:rgba(8,12,26,.75);outline:none;transition:.15s ease}
    .input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,77,255,.25)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .row4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .muted{color:var(--muted)} .small{font-size:12px}
    .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;transition:.15s ease;background:linear-gradient(135deg, var(--accent), var(--accent-2));
      color:#0b0f1a;font-weight:700;box-shadow:0 6px 20px rgba(124,77,255,.35), inset 0 -1px 0 rgba(255,255,255,.25)}
    .btn:hover{filter:saturate(1.1) brightness(1.02);transform:translateY(-1px)} .btn:active{transform:translateY(0)}
    .btn.secondary{background:rgba(255,255,255,.08);color:var(--text);box-shadow:none;border:1px solid var(--border)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .inline{display:flex;align-items:center;gap:10px}
    .chip{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.05);cursor:pointer;user-select:none}
    .chip:hover{border-color:var(--accent)} .chip.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,77,255,.2) inset}
    .out{white-space:pre-wrap;word-break:break-all;background:rgba(8,12,26,.8);border:1px solid var(--border);border-radius:12px;padding:12px}
    .keyHead{display:flex;align-items:center;gap:10px;margin-top:8px}
    .tag{font-size:11px;color:#111;background:linear-gradient(135deg,#34d399,#10b981);border-radius:999px;padding:3px 8px;font-weight:700}
    .switch{display:flex;gap:6px;background:rgba(255,255,255,.06);border:1px solid var(--border);padding:4px;border-radius:14px;width:max-content}
    .switch>button{border-radius:10px;padding:6px 10px;border:0;background:transparent;color:var(--muted)}
    .switch>button.active{background:rgba(124,77,255,.25);color:#fff}
    .gridFit{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px}
    .eye{position:absolute;right:10px;top:34px;width:32px;height:32px;display:grid;place-items:center;cursor:pointer;color:var(--muted)}
    .toast{position:fixed;right:22px;bottom:22px;background:#0f172a;border:1px solid var(--border);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.25s ease;max-width:480px}
    .toast.show{opacity:1;transform:translateY(0)} .toast .ok{color:var(--good)} .toast .bad{color:var(--bad)} .toast .warn{color:var(--warn)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="skm-logo.png" class="logo" alt="Steam KeyMaker logo">
        <div>
          <h1>Steam KeyMaker (Web)</h1>
          <div class="sub">Generate secure license keys (HMAC-SHA256, base64url)</div>
        </div>
      </div>
      <div class="inline">
        <button id="theme" class="btn secondary" title="Toggle theme">Theme</button>
        <button id="docs" class="btn secondary" title="About">Info</button>
      </div>
    </header>

    <!-- SECRET -->
    <section class="card">
      <div class="gridFit">
        <div>
          <label>SECRET (·ûè·üí·ûö·ûº·ûú·ûè·üÇ·ûä·ûº·ûÖ·ûÇ·üí·ûì·û∂·ûá·û∂·ûò·ûΩ·ûô App)</label>
          <input id="secret" type="password" class="input" placeholder="Enter SECRET (min 8 chars)">
          <div id="eye" class="eye" title="Show/Hide">üëÅÔ∏è</div>
          <label class="small"><input type="checkbox" id="remember"> Remember on this device</label>
        </div>
        <div class="inline" style="align-self:flex-end">
          <button id="genSecret" class="btn secondary">Generate secret</button>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section class="card">
      <div class="row">
        <div>
          <label>Name</label>
          <input id="name" class="input" placeholder="e.g. Name">
        </div>
        <div>
          <label>HWID (optional ‚Äì ·ûë·ûª·ûÄ·ûë·ûë·üÅ = universal)</label>
          <input id="hwid" class="input" placeholder="e.g. HWID Number">
        </div>
      </div>
    </section>

    <!-- DURATION / DATE -->
    <section class="card">
      <div class="inline" style="justify-content:space-between; margin-bottom:8px">
        <label style="margin:0">Expiry</label>
        <div class="switch">
          <button id="modeDuration" class="active">Duration</button>
          <button id="modeDate">Date</button>
        </div>
      </div>

      <!-- Duration mode -->
      <div id="durationPanel">
        <div class="row3">
          <div><label>Days</label><input id="days" type="number" min="0" class="input" value="7"></div>
          <div><label>Months</label><input id="months" type="number" min="0" class="input" value="0"></div>
          <div><label>Years</label><input id="years" type="number" min="0" class="input" value="0"></div>
        </div>
        <label style="margin-top:10px">Quick picks</label>
        <div class="row4">
          <div class="chip" data-pick="7d">7 days</div>
          <div class="chip" data-pick="1m">1 month</div>
          <div class="chip" data-pick="3m">3 months</div>
          <div class="chip" data-pick="6m">6 months</div>
          <div class="chip" data-pick="1y">1 year</div>
          <div class="chip" data-pick="2y">2 years</div>
          <div class="chip" data-pick="99y">Lifetime</div>
        </div>
      </div>

      <!-- Date mode -->
      <div id="datePanel" style="display:none">
        <div class="row">
          <div>
            <label>Expires on (local)</label>
            <input id="expiryDate" type="date" class="input">
          </div>
          <div>
            <label>Preview</label>
            <div id="datePreview" class="out small">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ACTIONS -->
    <section class="card">
      <div class="inline" style="gap:12px; flex-wrap:wrap">
        <button id="generate" class="btn">Generate key</button>
        <button id="copyMain" class="btn secondary" disabled>Copy</button>
        <button id="saveKey" class="btn secondary" disabled>Save .key</button>
      </div>
    </section>

    <!-- OUTPUT -->
    <section class="card">
      <div class="muted small">Payload preview</div>
      <div id="preview" class="out small">‚Äî</div>

      <div class="keyHead">
        <div class="muted small">KEY</div>
        <span class="tag">secure</span>
        <button id="copyInline" class="btn secondary" style="padding:6px 10px" disabled>Copy</button>
        <span id="copiedTip" class="small" style="color:var(--good); display:none">Copied!</span>
      </div>
      <div id="key" class="out">‚Äî</div>
    </section>

    <div id="toast" class="toast"></div>
  </div>

<script>
/* =================== Utilities & State =================== */
const $ = id => document.getElementById(id);
const qsa = sel => [...document.querySelectorAll(sel)];
const state = { key:null, mode:'duration', lifetime:false };

function toast(msg, tone='ok'){ const t=$('toast'); t.innerHTML='<span class="'+tone+'">'+msg+'</span>'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
const setTheme = t => document.documentElement.style.setProperty('--bg', t==='light' ? '#f8fafc' : '#0b0f1a');
$('theme').onclick = ()=>{ const dark=getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()==='#0b0f1a'; setTheme(dark?'light':'dark'); };
$('docs').onclick = ()=> alert('Format key: [base64url(payload)].[base64url(signature)]\nSignature = HMAC-SHA256(secret, payloadB64)\nNote: SECRET ·ûÇ·ûΩ·ûö·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûì·üÖ server ·ûü·ûò·üí·ûö·û∂·ûî·üã production');

/* =================== Secret remember/show =================== */
$('eye').onclick = ()=>{ const s=$('secret'); s.type = s.type==='password' ? 'text' : 'password'; };
(()=>{ const s = localStorage.getItem('km_secret'); if(s){ $('secret').value=s; $('remember').checked=true; }
  $('remember').addEventListener('change', e=>{ if(e.target.checked) localStorage.setItem('km_secret', $('secret').value||''); else localStorage.removeItem('km_secret'); });
  $('secret').addEventListener('input', ()=>{ if($('remember').checked) localStorage.setItem('km_secret', $('secret').value||''); });
})();

/* =================== Mode switch =================== */
function setMode(m){
  state.mode = m;
  $('modeDuration').classList.toggle('active', m==='duration');
  $('modeDate').classList.toggle('active', m==='date');
  $('durationPanel').style.display = (m==='duration') ? '' : 'none';
  $('datePanel').style.display     = (m==='date') ? '' : 'none';
}
$('modeDuration').onclick = ()=> setMode('duration');
$('modeDate').onclick     = ()=> setMode('date');

/* =================== Quick picks =================== */
qsa('.chip').forEach(ch => ch.addEventListener('click', ()=>{
  qsa('.chip').forEach(c=>c.classList.remove('active')); ch.classList.add('active');
  const v = ch.dataset.pick; state.lifetime = (v==='life');
  const set = (d=0,m=0,y=0)=>{ $('days').value=d; $('months').value=m; $('years').value=y; };
  if(v==='7d') set(7,0,0);
  if(v==='1m') set(0,1,0);
  if(v==='3m') set(0,3,0);
  if(v==='6m') set(0,6,0);
  if(v==='1y') set(0,0,1);
  if(v==='2y') set(0,0,2);
  if(v==='99y') set(0,0,99);
}));

/* =================== Date helpers =================== */
const enc = new TextEncoder();
const dayMS = 86400000;
const startOfDay = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
const endOfDay   = d => { const x=new Date(d); x.setHours(23,59,59,999); return x; };

function diffDaysInclusive(endDate){ // end of selected day MINUS start of today, inclusive
  const todayStart = startOfDay(new Date());
  const end = endOfDay(new Date(endDate));
  const diff = Math.max(0, Math.round((end - todayStart)/dayMS) + 1);
  return diff;
}

function formatDurationByDays(days){
  if(state.lifetime) return 'Lifetime';
  if(days % 365 === 0 && days >= 365){ const y=days/365; return y===1?'1 year':`${y} years`; }
  if(days % 30  === 0 && days >= 30 ){ const m=days/30 ; return m===1?'1 month':`${m} months`; }
  return days===1?'1 day':`${days} days`;
}

/* Preview for Date mode */
function updateDatePreview(){
  const v = $('expiryDate').value;
  if(!v){ $('datePreview').textContent = '‚Äî'; return; }
  const days = diffDaysInclusive(v);
  const dEnd = endOfDay(new Date(v));
  $('datePreview').textContent = `${formatDurationByDays(days)} ¬∑ ${dEnd.toDateString()}`;
}
$('expiryDate').addEventListener('input', updateDatePreview);

/* Persist some fields */
['name','hwid','days','months','years','expiryDate'].forEach(id=>{
  const k='km_'+id, el=$(id); const v=localStorage.getItem(k); if(v!==null) el.value=v;
  el.addEventListener('input', ()=>localStorage.setItem(k, el.value));
});

/* Default date = +30d (end of day) */
(function initDate(){
  const d = new Date(Date.now()+30*dayMS);
  const pad=n=>String(n).padStart(2,'0');
  $('expiryDate').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  updateDatePreview();
})();

/* =================== Crypto helpers =================== */
function base64urlFromBytes(bytes){ let bin=''; for(const b of bytes){ bin += String.fromCharCode(b); } return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
async function hmacSha256Base64url(secret, dataStr){
  const key = await crypto.subtle.importKey('raw', enc.encode(secret), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(dataStr));
  return base64urlFromBytes(new Uint8Array(sig));
}
function addDurationEndOfDay({days=0, months=0, years=0, lifetime=false}){
  if(lifetime) return null;
  const now = new Date(); const exp = new Date(now);
  exp.setFullYear(exp.getFullYear() + (+years||0));
  exp.setMonth(exp.getMonth() + (+months||0));
  exp.setDate(exp.getDate() + (+days||0));
  return endOfDay(exp);
}

/* =================== Key API (Browser) =================== */
const KeyAPI = {
  async generate({secret, name, hwid, days=0, months=0, years=0, lifetime=false, expOverride=null}){
    if(!secret || secret.length < 8) return { ok:false, error:'SECRET too short' };
    const now = new Date();
    const expDate = expOverride ? new Date(expOverride) : addDurationEndOfDay({days, months, years, lifetime});
    const payload = {
      v:1,
      name: (name||'').trim() || null,
      hwid: (hwid||'').trim() || null,
      iat: Math.floor(now.getTime()/1000),
      exp: expDate ? Math.floor(expDate.getTime()/1000) : null, // null => lifetime
    };
    const payloadB64 = base64urlFromBytes(enc.encode(JSON.stringify(payload)));
    const sigB64 = await hmacSha256Base64url(secret, payloadB64);
    const key = payloadB64 + '.' + sigB64; // no "SKM." prefix
    return { ok:true, key, payload, expISO: expDate ? expDate.toISOString() : null };
  },
  async saveKey(key){
    try{
      const a = document.createElement('a');
      a.download = 'license.key';
      a.href = URL.createObjectURL(new Blob([key], {type:'text/plain'})); a.click();
      return { canceled:false, filePath:'license.key' };
    }catch{ return { canceled:true }; }
  }
};

/* =================== Actions =================== */
$('genSecret').onclick = ()=>{
  const arr = crypto.getRandomValues(new Uint32Array(6));
  let s = btoa(String.fromCharCode(...new Uint8Array(arr.buffer))).replace(/[^a-zA-Z0-9]/g,'').slice(0,36);
  $('secret').value = `SK-${s}`; if($('remember').checked) localStorage.setItem('km_secret', $('secret').value);
  toast('New secret generated.','ok');
};
$('modeDuration').click(); // default

$('generate').addEventListener('click', async ()=>{
  const secret = $('secret').value;
  if(!secret || secret.length < 8) return toast('Please enter a valid SECRET (‚â• 8 chars).','bad');

  let days = Number($('days').value||0), months = Number($('months').value||0), years = Number($('years').value||0);
  let expOverride = null, durationDays = null;

  if(state.mode==='date'){
    const dStr = $('expiryDate').value;
    if(!dStr) return toast('Please choose an expiry date.','bad');
    expOverride = endOfDay(new Date(dStr)).toISOString();
    durationDays = diffDaysInclusive(dStr); // for preview string
    // when using exact date, ignore manual days/months/years
    days=0; months=0; years=0;
  } else {
    // duration mode ‚Üí compute the end-of-day date then duration days for preview
    const expTmp = addDurationEndOfDay({days, months, years, lifetime:state.lifetime});
    durationDays = state.lifetime ? null : Math.max(0, Math.round((expTmp - startOfDay(new Date()))/dayMS) + 1);
  }

  try{
    const res = await KeyAPI.generate({
      secret, name:$('name').value, hwid:$('hwid').value,
      days, months, years, lifetime:state.lifetime, expOverride
    });
    if(!res.ok) return toast(res.error || 'Failed to generate.','bad');

    state.key = res.key;
    $('key').textContent = res.key;
    $('copyInline').disabled = $('copyMain').disabled = $('saveKey').disabled = false;

    const durationStr = state.lifetime ? 'Lifetime' : formatDurationByDays(durationDays||0);
    $('preview').textContent = JSON.stringify(
      { duration: durationStr, payload: res.payload, expISO: res.expISO },
      null, 2
    );
    toast('Key generated.','ok');
  }catch(err){ toast(String(err),'bad'); }
});

async function doCopy(){
  if(!state.key) return;
  try{
    await navigator.clipboard.writeText(state.key);
    $('copiedTip').style.display='inline'; setTimeout(()=>$('copiedTip').style.display='none', 1200);
    toast('Copied to clipboard.');
  }catch{ toast('Clipboard unavailable (HTTPS only).','bad'); }
}
$('copyInline').addEventListener('click', doCopy);
$('copyMain').addEventListener('click', doCopy);

$('saveKey').addEventListener('click', async ()=>{
  if(!state.key) return;
  const r = await KeyAPI.saveKey(state.key);
  if(!r?.canceled) toast('Saved: '+r.filePath,'ok');
});
</script>
</body>
</html>
